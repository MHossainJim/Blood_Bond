<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Requests — Blood Bond</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">Blood Bond</h1>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="requests.html" class="active">Requests</a>
        <a href="campaigns.html">Campaigns</a>
      </nav>
      <div style="display:flex;align-items:center;gap:1rem">
        <div id="user-info" style="color:var(--muted);font-size:0.9rem"></div>
        <a href="profile.html"><img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f9d1.svg" alt="Profile" class="avatar" style="width:40px;height:40px" /></a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:2rem">
    <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:center;gap:0.75rem;margin-bottom:2rem">
      <button id="view-incoming" class="btn-toggle active">Incoming Requests</button>
      <button id="view-sent" class="btn-toggle">My Sent Requests</button>
    </div>

    <!-- Create Request Card (visible only in "My Sent Requests") -->
    <div id="create-card" class="card" style="display:none; margin:-0.5rem auto 1rem; max-width:720px; text-align:center;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap">
        <div style="text-align:left; flex:1">
          <h3 style="margin:0 0 .25rem; font-size:1.15rem">Create a new request</h3>
          <p class="muted" style="margin:0">Provide patient details and needed date.</p>
        </div>
        <button id="new-request" class="btn-blood">Create Request</button>
      </div>
    </div>

    <section id="requests-list">
      <div id="requests-container"></div>
    </section>
  </main>

  <!-- Modal: Create Request -->
  <div id="request-modal" class="modal" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="req-modal-title">
      <button id="req-modal-close" class="modal-close" aria-label="Close">✕</button>
      <h3 id="req-modal-title" style="margin-top:0">Create Blood Request</h3>
      <form id="req-form">
        <label for="req-name">Full name</label>
        <input id="req-name" name="name" type="text" required />

        <label for="req-phone">Phone number</label>
        <input id="req-phone" name="phone" type="tel" required />

        <label for="req-address">Address</label>
        <input id="req-address" name="address" type="text" required />

        <label for="req-blood">Blood group</label>
        <select id="req-blood" name="blood_group" required>
          <option value="">Choose</option>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="AB">AB</option>
          <option value="O">O</option>
        </select>

        <label for="req-rh">RH factor</label>
        <select id="req-rh" name="rh" required>
          <option value="">Choose</option>
          <option value="positive">Positive (+)</option>
          <option value="negative">Negative (-)</option>
        </select>

        <label for="req-gender">Gender</label>
        <select id="req-gender" name="gender" required>
          <option value="">Choose</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>

        <label for="req-date">Date blood needed</label>
        <input id="req-date" name="need_date" type="date" required />

        <div style="display:flex;gap:0.5rem;margin-top:0.75rem">
          <button type="submit" class="btn-blood">Submit Request</button>
          <button type="button" id="req-modal-cancel" class="btn-secondary">Cancel</button>
        </div>
      </form>
      <div id="req-modal-result" class="result" aria-live="polite"></div>
    </div>
  </div>

  <footer class="site-footer"><div class="container"><small>© Blood Bond</small></div></footer>

  <script src="auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const session = BBAuth.requireLogin(); if(!session) return;

      const listEl = document.getElementById('requests-container');
      const viewIncomingBtn = document.getElementById('view-incoming');
      const viewSentBtn = document.getElementById('view-sent');
      const newReqBtn = document.getElementById('new-request');
      const createCard = document.getElementById('create-card');
      const modal = document.getElementById('request-modal');
      const modalClose = document.getElementById('req-modal-close');
      const modalCancel = document.getElementById('req-modal-cancel');
      const reqForm = document.getElementById('req-form');
      const reqResult = document.getElementById('req-modal-result');
      let currentView = 'incoming';

      // Sample request data
      const sampleRequests = [
        {id:1, name:'Anita D.', blood:'B+', location:'Square Hospital', time:'2 hours ago', avatar:'https://i.pravatar.cc/150?img=47'},
        {id:2, name:'Rahul S.', blood:'B+', location:'Square Hospital', time:'2 hours ago', avatar:'https://i.pravatar.cc/150?img=12'},
        {id:3, name:'Rahul S.', blood:'B+', location:'Square Hospital', time:'2 hours ago', avatar:'https://i.pravatar.cc/150?img=13'},
        {id:4, name:'Rahul S.', blood:'A+', location:'Square Hospital', time:'2 hours ago', avatar:'https://i.pravatar.cc/150?img=14'},
        {id:5, name:'Anita D.', blood:'B+', location:'Square Hospital', time:'2 hours ago', avatar:'https://i.pravatar.cc/150?img=48'}
      ];

      function loadRequests(){
        listEl.innerHTML = '';
        let requests = [];
        if(currentView === 'incoming'){
          requests = sampleRequests;
        }else{
          const all = JSON.parse(localStorage.getItem('bb_requests')||'[]');
          requests = all.filter(r=> r.createdBy === session.identifier).map(r=>({
            id:r.id,
            name:r.name,
            blood:(r.blood || ((r.blood_group||'') + (r.rh==='negative'?'-':'+'))),
            location:r.address,
            time:new Date(r.time||r.need_date||Date.now()).toLocaleDateString(),
            avatar:'https://i.pravatar.cc/150?u=' + encodeURIComponent(r.name||r.id)
          }));
        }
        
        if(requests.length === 0){ 
          listEl.innerHTML = '<p class="muted" style="text-align:center;padding:2rem">No requests yet.</p>'; 
          return;
        }
        
        for(const r of requests){
          const el = document.createElement('div');
          el.className = 'request-card';
          el.innerHTML = `
            <img class="avatar" src="${r.avatar}" alt="${r.name}" />
            <div class="request-info">
              <h3 class="request-name">${r.name}</h3>
              <div class="request-details">Urgent: ${r.blood} Blood needed at ${r.location}</div>
              <div class="request-time">${r.time}</div>
            </div>
            <div class="request-actions">
              <button class="btn-accept" onclick="acceptRequest(${r.id})">Accept</button>
              <button class="btn-reject" onclick="rejectRequest(${r.id})">Reject</button>
            </div>
          `;
          listEl.appendChild(el);
        }
      }

      function setView(view){
        currentView = view;
        viewIncomingBtn.classList.toggle('active', view === 'incoming');
        viewSentBtn.classList.toggle('active', view === 'sent');
        // Show create card only for "My Sent Requests"
        if(createCard) createCard.style.display = (view === 'sent') ? 'block' : 'none';
        loadRequests();
      }

      viewIncomingBtn.addEventListener('click', ()=> setView('incoming'));
      viewSentBtn.addEventListener('click', ()=> setView('sent'));

      // Modal helpers
      function openModal(){ modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; reqResult.textContent=''; reqForm.reset(); }
      function closeModal(){ modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
      if(newReqBtn) newReqBtn.addEventListener('click', openModal);
      if(modalClose) modalClose.addEventListener('click', closeModal);
      if(modalCancel) modalCancel.addEventListener('click', closeModal);

      // Submit new request
      if(reqForm){
        reqForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          const fd = new FormData(reqForm);
          const name = (fd.get('name')||'').trim();
          const phone = (fd.get('phone')||'').trim();
          const address = (fd.get('address')||'').trim();
          const blood_group = fd.get('blood_group');
          const rh = fd.get('rh');
          const gender = fd.get('gender');
          const need_date = fd.get('need_date');
          if(!name || !phone || !address || !blood_group || !rh || !gender || !need_date){
            reqResult.style.color = '#ffb4b4';
            reqResult.textContent = 'Please fill all required fields.';
            return;
          }
          const blood = `${blood_group}${rh==='negative'?'-':'+'}`;
          const item = { id: Date.now(), name, phone, address, gender, blood_group, rh, blood, need_date, createdBy: session.identifier, time: new Date().toISOString() };
          const key = 'bb_requests';
          const existing = JSON.parse(localStorage.getItem(key)||'[]');
          existing.push(item);
          localStorage.setItem(key, JSON.stringify(existing));
          reqResult.style.color = '#9fe8c0';
          reqResult.textContent = 'Request created.';
          setTimeout(()=>{ closeModal(); if(currentView==='sent') loadRequests(); }, 600);
        });
      }

      window.acceptRequest = function(id){
        alert('Request accepted! ID: ' + id);
      };

      window.rejectRequest = function(id){
        alert('Request rejected! ID: ' + id);
      };

      loadRequests();
    });
  </script>
</body>
</html>
