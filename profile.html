<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile ‚Äî Blood Bond</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">Blood Bond</h1>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="requests.html">Requests</a>
        <a href="campaigns.html" class="active">Campaigns</a>
      </nav>
      <div style="display:flex;align-items:center;gap:1rem">
        <div id="user-info" style="color:var(--muted);font-size:0.9rem"></div>
        <a href="profile.html"><img src="https://i.pravatar.cc/80" alt="Profile" class="avatar" style="width:40px;height:40px" /></a>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:2rem;max-width:1000px">
    <!-- Profile Header Card -->
    <div class="profile-header">
      <div class="profile-avatar">
        <img id="profile-avatar-img" class="avatar" src="https://i.pravatar.cc/150?img=12" alt="Profile" />
        <label for="profile-file" class="profile-edit-icon" style="cursor:pointer" title="Edit photo">
          ‚úèÔ∏è
        </label>
        <input id="profile-file" name="picture_file" type="file" accept="image/*" style="display:none" />
      </div>
      <div class="profile-info">
        <h1 class="profile-name" id="profile-name">Rahul S.</h1>
        <span class="blood-badge" id="profile-blood">A+</span>
        <div class="profile-willing">
          <span style="color:var(--muted);font-weight:500">Willing to Donate</span>
          <label class="toggle-switch">
            <input type="checkbox" id="willing-toggle" checked />
            <span class="toggle-slider"></span>
          </label>
          <span style="color:var(--text);font-weight:600">ON</span>
        </div>
      </div>
    </div>

    <!-- Eligibility & Profile Form -->
    <section class="card">
      <h3 style="margin-top:0">Donor Eligibility</h3>
      <form id="profile-form">
        <input type="hidden" id="profile-pic" name="picture" />

        <label for="profile-nid">NID Number</label>
        <input id="profile-nid" name="nid" type="text" placeholder="Enter your NID number" />

        <label for="profile-blood-group">Blood Group</label>
        <select id="profile-blood-group" name="blood_group">
          <option value="">Choose</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>

        <label for="profile-age">Age</label>
        <input id="profile-age" name="age" type="number" min="18" max="120" placeholder="Your age" />

        <label for="profile-address">Address</label>
        <input id="profile-address" name="address" type="text" placeholder="Enter your full address" style="background:var(--bg);border:1px solid var(--border);padding:1rem;border-radius:8px" />

        <button type="submit" class="btn-blood" style="width:auto;align-self:flex-end;margin-top:1rem">Save Changes</button>
      </form>
      <div id="profile-result" class="result"></div>
      <p class="muted" id="eligibility-status" style="margin-top:0.5rem"></p>
    </section>

    <!-- Email and Phone (read-only) -->
    <section class="card">
      <h3 style="margin-top:0">Email Address</h3>
      <div style="background:var(--bg);border:1px solid var(--border);padding:1rem;border-radius:8px;display:flex;align-items:center;gap:0.5rem;color:var(--muted)">
        üîí <span id="profile-email">rahul@example.com</span>
      </div>

      <h3 style="margin-top:1.5rem">Phone Number</h3>
      <div style="background:var(--bg);border:1px solid var(--border);padding:1rem;border-radius:8px;display:flex;align-items:center;gap:0.5rem;color:var(--muted)">
        üîí <span id="profile-phone">+88017...33481</span>
      </div>
    </section>

    <!-- Logout Button -->
    <div style="text-align:center;margin-top:2rem">
      <button id="logout-btn" class="btn-secondary" style="width:100%;max-width:600px;border-color:var(--brand);color:var(--brand);padding:1rem;font-size:1rem">Log Out</button>
    </div>
  </main>

  <footer class="site-footer"><div class="container"><small>¬© Blood Bond</small></div></footer>

  <script src="auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const session = BBAuth.requireLogin(); if(!session) return;

      const profileForm = document.getElementById('profile-form');
      const profileResult = document.getElementById('profile-result');
      const willingToggle = document.getElementById('willing-toggle');
      const logoutBtn = document.getElementById('logout-btn');

      // Load current user data
      const users = JSON.parse(localStorage.getItem('bb_users')||'[]');
      const me = users.find(u=>u.id === session.userId) || {};
      
      // Update profile display
      if(me.name) document.getElementById('profile-name').textContent = me.name;
      if(me.blood_group) document.getElementById('profile-blood').textContent = me.blood_group;
      if(me.email) document.getElementById('profile-email').textContent = me.email;
      if(me.phone) document.getElementById('profile-phone').textContent = me.phone;
      if(me.address) document.getElementById('profile-address').value = me.address;
      if(me.nid) document.getElementById('profile-nid').value = me.nid;
      if(me.blood_group) document.getElementById('profile-blood-group').value = me.blood_group;
      if(me.age) document.getElementById('profile-age').value = me.age;
      if(me.picture) {
        document.getElementById('profile-pic').value = me.picture;
        document.getElementById('profile-avatar-img').src = me.picture;
      }

      function updateEligibilityStatus(user){
        const ok = !!(user.nid && user.blood_group && user.age && user.address);
        const el = document.getElementById('eligibility-status');
        if(el){
          el.textContent = ok ? 'Eligibility complete: you can donate/request without extra form.' : 'Complete eligibility (NID, blood group, age, address) to skip forms on homepage.';
          el.style.color = ok ? '#4ade80' : 'var(--muted)';
        }
      }

      // file upload -> Data URL conversion
      const fileInput = document.getElementById('profile-file');
      fileInput.addEventListener('change', async (ev)=>{
        const f = ev.target.files && ev.target.files[0];
        if(!f) return;
        if(!f.type.startsWith('image/')){
          profileResult.textContent = 'Please upload an image file.'; 
          profileResult.style.color = '#ef4444';
          return;
        }
        const dataUrl = await new Promise((res,rej)=>{
          const r = new FileReader();
          r.onload = ()=>res(r.result);
          r.onerror = ()=>rej(new Error('File read error'));
          r.readAsDataURL(f);
        });
        // set preview and set hidden URL field so save will persist
        document.getElementById('profile-avatar-img').src = dataUrl;
        document.getElementById('profile-pic').value = dataUrl;
        
        // Auto-save picture
        const users = JSON.parse(localStorage.getItem('bb_users')||'[]');
        const idx = users.findIndex(u=>u.id===session.userId);
        if(idx>=0){
          users[idx].picture = dataUrl;
          localStorage.setItem('bb_users', JSON.stringify(users));
        }
      });

      profileForm.addEventListener('submit', e=>{
        e.preventDefault();
        const users = JSON.parse(localStorage.getItem('bb_users')||'[]');
        const idx = users.findIndex(u=>u.id===session.userId);
        if(idx>=0){
          users[idx].nid = document.getElementById('profile-nid').value.trim();
          users[idx].blood_group = document.getElementById('profile-blood-group').value;
          users[idx].age = parseInt(document.getElementById('profile-age').value||'');
          users[idx].address = document.getElementById('profile-address').value.trim();
          users[idx].picture = document.getElementById('profile-pic').value.trim();
          localStorage.setItem('bb_users', JSON.stringify(users));
          profileResult.textContent = 'Profile updated successfully!';
          profileResult.style.color = '#4ade80';
          setTimeout(() => profileResult.textContent = '', 3000);
          updateEligibilityStatus(users[idx]);
        }
      });

      // Willing to donate toggle
      willingToggle.addEventListener('change', (e)=>{
        const users = JSON.parse(localStorage.getItem('bb_users')||'[]');
        const idx = users.findIndex(u=>u.id===session.userId);
        if(idx>=0){
          users[idx].willingToDonate = e.target.checked;
          localStorage.setItem('bb_users', JSON.stringify(users));
        }
      });

      // Logout
      logoutBtn.addEventListener('click', ()=>{
        BBAuth.logout();
      });

      // Initialize eligibility status
      updateEligibilityStatus(me || {});
    });
  </script>
</body>
</html>
